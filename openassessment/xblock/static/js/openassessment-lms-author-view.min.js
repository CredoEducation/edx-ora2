function OpenAssessmentBlock(runtime,element,data){var server=new OpenAssessment.Server(runtime,element);new OpenAssessment.BaseView(runtime,element,server,data).load()}function CourseOpenResponsesListingBlock(runtime,element,data){new OpenAssessment.CourseItemsListingView(runtime,element).refreshGrids()}function StaffAssessmentBlock(runtime,element,data){var server=new OpenAssessment.Server(runtime,element);new OpenAssessment.BaseView(runtime,element,server,data).staffAreaView.installHandlers()}if("undefined"!=typeof OpenAssessment&&OpenAssessment||(OpenAssessment={}),void 0===window.gettext&&(window.gettext=function(text){return text}),void 0===window.ngetgext&&(window.ngettext=function(singularText,pluralText,n){return n>1?pluralText:singularText}),void 0===window.Logger&&(window.Logger={log:function(){}}),void 0===window.MathJax&&(window.MathJax={Hub:{Typeset:function(){},Queue:function(){}}}),void 0===OpenAssessment.Server||!OpenAssessment.Server){OpenAssessment.Server=function(runtime,element){this.runtime=runtime,this.element=element};var jsonContentType="application/json; charset=utf-8";OpenAssessment.Server.prototype={url:function(handler){return this.runtime.handlerUrl(this.element,handler)},render:function(component){var view=this,url=this.url("render_"+component);return $.Deferred(function(defer){$.ajax({url:url,type:"POST",dataType:"html"}).done(function(data){defer.resolveWith(view,[data])}).fail(function(){defer.rejectWith(view,[gettext("This section could not be loaded.")])})}).promise()},renderLatex:function(element){element.filter(".allow--latex").each(function(){MathJax.Hub.Queue(["Typeset",MathJax.Hub,this])})},renderContinuedPeer:function(){var view=this,url=this.url("render_peer_assessment");return $.Deferred(function(defer){$.ajax({url:url,type:"POST",dataType:"html",data:{continue_grading:!0}}).done(function(data){defer.resolveWith(view,[data])}).fail(function(){defer.rejectWith(view,[gettext("This section could not be loaded.")])})}).promise()},studentInfo:function(studentUsername,options){var url=this.url("render_student_info");return $.Deferred(function(defer){$.ajax({url:url,type:"POST",dataType:"html",data:_.extend({student_username:studentUsername},options)}).done(function(data){defer.resolveWith(this,[data])}).fail(function(){defer.rejectWith(this,[gettext("This section could not be loaded.")])})}).promise()},staffGradeForm:function(){var url=this.url("render_staff_grade_form");return $.Deferred(function(defer){$.ajax({url:url,type:"POST",dataType:"html"}).done(function(data){defer.resolveWith(this,[data])}).fail(function(){defer.rejectWith(this,[gettext("The staff assessment form could not be loaded.")])})}).promise()},staffGradeCounts:function(){var url=this.url("render_staff_grade_counts");return $.Deferred(function(defer){$.ajax({url:url,type:"POST",dataType:"html"}).done(function(data){defer.resolveWith(this,[data])}).fail(function(){defer.rejectWith(this,[gettext("The display of ungraded and checked out responses could not be loaded.")])})}).promise()},submit:function(submission){var url=this.url("submit");return $.Deferred(function(defer){$.ajax({type:"POST",url:url,data:JSON.stringify({submission:submission}),contentType:jsonContentType}).done(function(data){if(data[0]){var studentId=data[1],attemptNum=data[2];defer.resolveWith(this,[studentId,attemptNum])}else{var errorNum=data[1],errorMsg=data[2];defer.rejectWith(this,[errorNum,errorMsg])}}).fail(function(){defer.rejectWith(this,["AJAX",gettext("This response could not be submitted.")])})}).promise()},save:function(submission){var url=this.url("save_submission");return $.Deferred(function(defer){$.ajax({type:"POST",url:url,data:JSON.stringify({submission:submission}),contentType:jsonContentType}).done(function(data){data.success?defer.resolve():defer.rejectWith(this,[data.msg])}).fail(function(){defer.rejectWith(this,[gettext("This response could not be saved.")])})}).promise()},submitFeedbackOnAssessment:function(text,options){var url=this.url("submit_feedback"),payload=JSON.stringify({feedback_text:text,feedback_options:options});return $.Deferred(function(defer){$.ajax({type:"POST",url:url,data:payload,contentType:jsonContentType}).done(function(data){data.success?defer.resolve():defer.rejectWith(this,[data.msg])}).fail(function(){defer.rejectWith(this,[gettext("This feedback could not be submitted.")])})}).promise()},submitAssessment:function(assessmentType,payload){var url=this.url(assessmentType);return $.Deferred(function(defer){$.ajax({type:"POST",url:url,data:JSON.stringify(payload),contentType:jsonContentType}).done(function(data){data.success?defer.resolve():defer.rejectWith(this,[data.msg])}).fail(function(){defer.rejectWith(this,[gettext("This assessment could not be submitted.")])})}).promise()},peerAssess:function(optionsSelected,criterionFeedback,overallFeedback,submissionID){return this.submitAssessment("peer_assess",{options_selected:optionsSelected,criterion_feedback:criterionFeedback,overall_feedback:overallFeedback,submission_uuid:submissionID})},selfAssess:function(optionsSelected,criterionFeedback,overallFeedback){return this.submitAssessment("self_assess",{options_selected:optionsSelected,criterion_feedback:criterionFeedback,overall_feedback:overallFeedback})},staffAssess:function(optionsSelected,criterionFeedback,overallFeedback,submissionID,assessType){return this.submitAssessment("staff_assess",{options_selected:optionsSelected,criterion_feedback:criterionFeedback,overall_feedback:overallFeedback,submission_uuid:submissionID,assess_type:assessType})},trainingAssess:function(optionsSelected){var url=this.url("training_assess"),payload=JSON.stringify({options_selected:optionsSelected});return $.Deferred(function(defer){$.ajax({type:"POST",url:url,data:payload,contentType:jsonContentType}).done(function(data){data.success?defer.resolveWith(this,[data.corrections]):defer.rejectWith(this,[data.msg])}).fail(function(){defer.rejectWith(this,[gettext("This assessment could not be submitted.")])})})},scheduleTraining:function(){var url=this.url("schedule_training");return $.Deferred(function(defer){$.ajax({type:"POST",url:url,data:'""',contentType:jsonContentType}).done(function(data){data.success?defer.resolveWith(this,[data.msg]):defer.rejectWith(this,[data.msg])}).fail(function(){defer.rejectWith(this,[gettext("This assessment could not be submitted.")])})})},rescheduleUnfinishedTasks:function(){var url=this.url("reschedule_unfinished_tasks");return $.Deferred(function(defer){$.ajax({type:"POST",url:url,data:'""',contentType:jsonContentType}).done(function(data){data.success?defer.resolveWith(this,[data.msg]):defer.rejectWith(this,[data.msg])}).fail(function(){defer.rejectWith(this,[gettext("One or more rescheduling tasks failed.")])})})},updateEditorContext:function(options){var url=this.url("update_editor_context"),payload=JSON.stringify({prompts:options.prompts,feedback_prompt:options.feedbackPrompt,feedback_default_text:options.feedback_default_text,title:options.title,submission_start:options.submissionStart,submission_due:options.submissionDue,criteria:options.criteria,assessments:options.assessments,editor_assessments_order:options.editorAssessmentsOrder,text_response:options.textResponse,file_upload_response:options.fileUploadResponse,file_upload_type:options.fileUploadType,white_listed_file_types:options.fileTypeWhiteList,allow_latex:options.latexEnabled,leaderboard_show:options.leaderboardNum});return $.Deferred(function(defer){$.ajax({type:"POST",url:url,data:payload,contentType:jsonContentType}).done(function(data){data.success?defer.resolve():defer.rejectWith(this,[data.msg])}).fail(function(){defer.rejectWith(this,[gettext("This problem could not be saved.")])})}).promise()},checkReleased:function(){var url=this.url("check_released");return $.Deferred(function(defer){$.ajax({type:"POST",url:url,data:'""',contentType:jsonContentType}).done(function(data){data.success?defer.resolveWith(this,[data.is_released]):defer.rejectWith(this,[data.msg])}).fail(function(){defer.rejectWith(this,[gettext("The server could not be contacted.")])})}).promise()},getUploadUrl:function(contentType,filename,filenum){var url=this.url("upload_url");return $.Deferred(function(defer){$.ajax({type:"POST",url:url,data:JSON.stringify({contentType:contentType,filename:filename,filenum:filenum}),contentType:jsonContentType}).done(function(data){data.success?defer.resolve(data.url):defer.rejectWith(this,[data.msg])}).fail(function(){defer.rejectWith(this,[gettext("Could not retrieve upload url.")])})}).promise()},removeUploadedFiles:function(){var url=this.url("remove_all_uploaded_files");return $.Deferred(function(defer){$.ajax({type:"POST",url:url,data:JSON.stringify({}),contentType:jsonContentType}).done(function(data){data.success?defer.resolve():defer.rejectWith(this,[data.msg])}).fail(function(){defer.rejectWith(this,[gettext("Server error.")])})}).promise()},saveFilesDescriptions:function(descriptions){var url=this.url("save_files_descriptions");return $.Deferred(function(defer){$.ajax({type:"POST",url:url,data:JSON.stringify({descriptions:descriptions}),contentType:jsonContentType}).done(function(data){data.success?defer.resolve():defer.rejectWith(this,[data.msg])}).fail(function(){defer.rejectWith(this,[gettext("Server error.")])})}).promise()},getDownloadUrl:function(filenum){var url=this.url("download_url");return $.Deferred(function(defer){$.ajax({type:"POST",url:url,data:JSON.stringify({filenum:filenum}),contentType:jsonContentType}).done(function(data){data.success?defer.resolve(data.url):defer.rejectWith(this,[data.msg])}).fail(function(){defer.rejectWith(this,[gettext("Could not retrieve download url.")])})}).promise()},cancelSubmission:function(submissionID,comments){var url=this.url("cancel_submission"),payload=JSON.stringify({submission_uuid:submissionID,comments:comments});return $.Deferred(function(defer){$.ajax({type:"POST",url:url,data:payload,contentType:jsonContentType}).done(function(data){data.success&&defer.resolveWith(this,[data.msg])}).fail(function(){defer.rejectWith(this,[gettext("The submission could not be removed from the grading pool.")])})}).promise()},publishEvent:function(eventName,eventData){eventData.event_name=eventName;var url=this.url("publish_event"),payload=JSON.stringify(eventData);$.ajax({type:"POST",url:url,data:payload,contentType:jsonContentType})}}}"undefined"!=typeof OpenAssessment&&OpenAssessment||(OpenAssessment={}),void 0===window.gettext&&(window.gettext=function(text){return text}),void 0===window.ngetgext&&(window.ngettext=function(singularText,pluralText,n){return n>1?pluralText:singularText}),void 0===window.Logger&&(window.Logger={log:function(){}}),void 0===window.MathJax&&(window.MathJax={Hub:{Typeset:function(){},Queue:function(){}}}),OpenAssessment.BaseView=function(runtime,element,server,data){this.runtime=runtime,this.element=element,this.server=server,this.fileUploader=new OpenAssessment.FileUploader,this.responseView=new OpenAssessment.ResponseView(this.element,this.server,this.fileUploader,this,data),this.trainingView=new OpenAssessment.StudentTrainingView(this.element,this.server,this),this.selfView=new OpenAssessment.SelfView(this.element,this.server,this),this.peerView=new OpenAssessment.PeerView(this.element,this.server,this),this.staffView=new OpenAssessment.StaffView(this.element,this.server,this),this.gradeView=new OpenAssessment.GradeView(this.element,this.server,this),this.leaderboardView=new OpenAssessment.LeaderboardView(this.element,this.server,this),this.messageView=new OpenAssessment.MessageView(this.element,this.server,this),this.staffAreaView=new OpenAssessment.StaffAreaView(this.element,this.server,this),this.usageID="",this.srStatusUpdates=[]},void 0!==OpenAssessment.unsavedChanges&&OpenAssessment.unsavedChanges||(OpenAssessment.unsavedChanges={}),OpenAssessment.clearUnsavedChanges=function(){OpenAssessment.unsavedChanges={},window.onbeforeunload=null},OpenAssessment.BaseView.prototype={IS_SHOWING_CLASS:"is--showing",SLIDABLE_CLASS:"ui-slidable",SLIDABLE_CONTENT_CLASS:"ui-slidable__content",SLIDABLE_CONTROLS_CLASS:"ui-slidable__control",SLIDABLE_CONTAINER_CLASS:"ui-slidable__container",READER_FEEDBACK_CLASS:".sr.reader-feedback",scrollToTop:function(selector){selector||(selector=".openassessment__steps"),$.scrollTo instanceof Function&&($(window).scrollTo($(selector,this.element),800,{offset:-50}),$(selector+" > header ."+this.SLIDABLE_CLASS,this.element).focus())},srClear:function(){$(this.READER_FEEDBACK_CLASS).html("")},srReadTexts:function(texts){var $readerFeedbackSelector=$(this.READER_FEEDBACK_CLASS),htmlFeedback="";this.srClear(),$.each(texts,function(ids,value){htmlFeedback=htmlFeedback+"<p>"+value+"</p>\n"}),$readerFeedbackSelector.html(htmlFeedback)},areSRStepsLoading:function(){return this.responseView.isRendering||this.peerView.isRendering||this.selfView.isRendering||this.gradeView.isRendering||this.trainingView.isRendering||this.staffView.isRendering},announceStatusChangeToSRandFocus:function(stepID,usageID,gradeStatus,currentView,focusID){var text=this.getStatus(stepID,currentView,gradeStatus);void 0!==usageID&&$(stepID,currentView.element).hasClass("is--showing")&&void 0!==focusID?($(focusID,currentView.element).focus(),this.srStatusUpdates.push(text)):currentView.announceStatus&&this.srStatusUpdates.push(text),!this.areSRStepsLoading()&&this.srStatusUpdates.length>0&&(this.srReadTexts(this.srStatusUpdates),this.srStatusUpdates=[]),currentView.announceStatus=!1},getStatus:function(stepID,currentView,gradeStatus){var cssBase=stepID+" .step__header .step__title ",cssStringTitle=cssBase+".step__label",cssStringStatus=cssBase+".step__status";return gradeStatus&&(cssStringStatus=cssBase+".grade__value"),$(cssStringTitle,currentView.element).text().trim()+" "+$(cssStringStatus,currentView.element).text().trim()},setUpCollapseExpand:function(parentElement){var view=this;$("."+view.SLIDABLE_CONTROLS_CLASS,parentElement).each(function(){$(this).on("click",function(event){event.preventDefault();var $slidableControl=$(event.target).closest("."+view.SLIDABLE_CONTROLS_CLASS),$container=$slidableControl.closest("."+view.SLIDABLE_CONTAINER_CLASS),$toggleButton=$slidableControl.find("."+view.SLIDABLE_CLASS),$panel=$slidableControl.next("."+view.SLIDABLE_CONTENT_CLASS);$container.hasClass("is--showing")?($panel.slideUp(),$toggleButton.attr("aria-expanded","false"),$container.removeClass("is--showing")):$container.hasClass("has--error")||$container.hasClass("is--empty")||$container.hasClass("is--unavailable")||($panel.slideDown(),$toggleButton.attr("aria-expanded","true"),$container.addClass("is--showing")),$container.removeClass("is--initially--collapsed ")})})},bindLatexPreview:function(parentElement){parentElement.find(".submission__preview__item").hide(),parentElement.find(".submission__preview").click(function(eventObject){eventObject.preventDefault();var previewName=$(eventObject.target).data("input"),previewText=parentElement.find('textarea[data-preview="'+previewName+'"]').val(),previewContainer=parentElement.find('.preview_content[data-preview="'+previewName+'"]');previewContainer.html(previewText.replace(/\r\n|\r|\n/g,"<br />")),previewContainer.parent().parent().parent().show(),MathJax.Hub.Queue(["Typeset",MathJax.Hub,previewContainer[0]])})},getUsageID:function(){return this.usageID||(this.usageID=$(this.element).data("usage-id")),this.usageID},load:function(){this.responseView.load(),this.loadAssessmentModules(),this.staffAreaView.load()},loadAssessmentModules:function(usageID){this.trainingView.load(usageID),this.peerView.load(usageID),this.staffView.load(usageID),this.selfView.load(usageID),this.gradeView.load(usageID),this.leaderboardView.load(usageID)},loadMessageView:function(){this.messageView.load()},toggleActionError:function(type,message){var element=this.element,container=null;if("save"===type?container=".response__submission__actions":"submit"===type||"peer"===type||"self"===type||"student-training"===type?container=".step__actions":"feedback_assess"===type?container=".submission__feedback__actions":"upload"===type&&(container=".upload__error"),null===container?null!==message&&console.log(message):($(container+" .message__content",element).html("<p>"+(message?_.escape(message):"")+"</p>"),$(container,element).toggleClass("has--error",null!==message),$(container+" > .message",element).focus()),null!==message){var contentTitle=$(container+" .message__title").text();this.srReadTexts([contentTitle,message])}},showLoadError:function(stepName,errorMessage){errorMessage||(errorMessage=gettext("Unable to load"));var $container=$(".step--"+stepName);$container.toggleClass("has--error",!0),$container.removeClass("is--showing"),$container.find(".ui-slidable").attr("aria-expanded","false"),$container.find(".step__status__value i").removeClass().addClass("icon fa fa-exclamation-triangle"),$container.find(".step__status__value .copy").html(_.escape(errorMessage))},unsavedWarningEnabled:function(enabled,key,message){if(void 0===enabled)return null!==window.onbeforeunload;var usageID=$(this.element).data("usage-id");enabled?(void 0!==OpenAssessment.unsavedChanges[usageID]&&OpenAssessment.unsavedChanges[usageID]||(OpenAssessment.unsavedChanges[usageID]={}),OpenAssessment.unsavedChanges[usageID][key]=message,window.onbeforeunload=function(){for(var xblockUsageID in OpenAssessment.unsavedChanges)if(OpenAssessment.unsavedChanges.hasOwnProperty(xblockUsageID))for(var key in OpenAssessment.unsavedChanges[xblockUsageID])if(OpenAssessment.unsavedChanges[xblockUsageID].hasOwnProperty(key))return OpenAssessment.unsavedChanges[xblockUsageID][key]}):void 0!==OpenAssessment.unsavedChanges[usageID]&&(delete OpenAssessment.unsavedChanges[usageID][key],$.isEmptyObject(OpenAssessment.unsavedChanges[usageID])&&delete OpenAssessment.unsavedChanges[usageID],$.isEmptyObject(OpenAssessment.unsavedChanges)&&(window.onbeforeunload=null))},buttonEnabled:function(className,enabled){var $element=$(className,this.element);return void 0===enabled?!$element.prop("disabled"):($element.prop("disabled",!enabled),enabled)}},function(OpenAssessment){"use strict";OpenAssessment.CourseItemsListingView=function(runtime,element){var self=this,$section=$(element),block=$section.find(".open-response-assessment-block"),itemViewEnabled=1===parseInt(block.data("item-view-enabled"))&&XBlock;this.$section=$section,this.runtime=runtime,this.oraData=$.parseJSON($("#open-response-assessment-items").text()),$section.find(".open-response-assessment-content").hide(),$section.find(".open-response-assessment-item").hide(),$section.find(".open-response-assessment-msg").show();var AssessmentCell=Backgrid.UriCell.extend({staff:!1,render:function(){this.$el.empty();var url=this.model.get(this.staff?"url_grade_available_responses":"url_base"),rawValue=this.model.get(this.column.get("name")),staffAssessment=this.model.get("staff_assessment"),formattedValue=this.formatter.fromRaw(rawValue,this.model),link=null;return itemViewEnabled&&(!this.staff||this.staff&&staffAssessment)?(link=$("<a>",{text:formattedValue,title:this.title||formattedValue}),this.$el.append(link),link.on("click",$.proxy(self,"displayOraBlock",url))):this.$el.append(formattedValue),this.delegateEvents(),this}}),StaffCell=AssessmentCell.extend({staff:!0});this._columns=[{name:"parent_name",label:gettext("Unit Name"),label_summary:gettext("Units"),cell:"string",num:!1,editable:!1},{name:"name",label:gettext("Assessment"),label_summary:gettext("Assessments"),cell:AssessmentCell,num:!1,editable:!1},{name:"total",label:gettext("Total Responses"),label_summary:gettext("Total Responses"),cell:"string",num:!0,editable:!1},{name:"training",label:gettext("Training"),label_summary:gettext("Training"),cell:"string",num:!0,editable:!1},{name:"peer",label:gettext("Peer"),label_summary:gettext("Peer"),cell:"string",num:!0,editable:!1},{name:"self",label:gettext("Self"),label_summary:gettext("Self"),cell:"string",num:!0,editable:!1},{name:"waiting",label:gettext("Waiting"),label_summary:gettext("Waiting"),cell:"string",num:!0,editable:!1},{name:"staff",label:gettext("Staff"),label_summary:gettext("Staff"),cell:StaffCell,num:!0,editable:!1},{name:"done",label:gettext("Final Grade Received"),label_summary:gettext("Final Grade Received"),cell:"string",num:!0,editable:!1}]},OpenAssessment.CourseItemsListingView.prototype.refreshGrids=function(force){force=force||!1;var self=this,$section=this.$section,block=$section.find(".open-response-assessment-block"),dataUrl=this.runtime.handlerUrl($section,"get_ora2_responses");if(!parseInt(block.data("rendered"))||force)return $.Deferred(function(defer){$.ajax({type:"GET",dataType:"json",url:dataUrl}).done(function(data){self.renderGrids(data),defer.resolve()}).fail(function(data,textStatus){$section.find(".open-response-assessment-msg").text(gettext("List of Open Assessments is unavailable")),defer.rejectWith(this,[textStatus])})}).promise()},OpenAssessment.CourseItemsListingView.prototype.renderGrids=function(data){var self=this,$section=this.$section,block=$section.find(".open-response-assessment-block"),oraSteps=["training","peer","self","waiting","staff","done"];$.each(self.oraData,function(i,oraItem){var total=0,itemId=oraItem.id;$.each(oraSteps,function(j,step){oraItem[step]=0}),itemId in data&&(_.extend(oraItem,data[itemId]),oraItem.staff_assessment&&(oraItem.staff=oraItem.waiting,oraItem.waiting=0)),$.each(oraSteps,function(j,step){total+=oraItem[step]}),oraItem.total=total}),block.data("rendered",1),$section.find(".open-response-assessment-msg").hide(),self.showSummaryGrid(self.oraData),self.showOpenResponsesGrid(self.oraData)},OpenAssessment.CourseItemsListingView.prototype.showSummaryGrid=function(data){var $section=this.$section,summaryData=[],summaryDataMap={};$section.find(".open-response-assessment-summary").empty(),$.each(this._columns,function(index,v){summaryData.push({title:v.label_summary,value:0,num:v.num,class:v.name}),summaryDataMap[v.name]=index}),$.each(data,function(index,obj){$.each(obj,function(key,value){var idx=0;key in summaryDataMap&&(idx=summaryDataMap[key],summaryData[idx].num?summaryData[idx].value+=value:summaryData[idx].value+=1)})});var templateData=_.template($("#open-response-assessment-summary-tpl").text());$section.find(".open-response-assessment-summary").append(templateData({oraSummary:summaryData}))},OpenAssessment.CourseItemsListingView.prototype.showOpenResponsesGrid=function(data){var $section=this.$section;$section.find(".open-response-assessment-content").show();var collection=new Backbone.Collection(data);$section.find(".open-response-assessment-main-table").empty();var grid=new Backgrid.Grid({columns:this._columns,collection:collection});$section.find(".open-response-assessment-main-table").append(grid.render().el)},OpenAssessment.CourseItemsListingView.prototype.displayOraBlock=function(url){var $section=this.$section,self=this;return $section.find(".open-response-assessment-content").hide(),$section.find(".open-response-assessment-msg").text(gettext("Please wait")).show(),$.Deferred(function(defer){$.ajax({type:"GET",dataType:"json",url:url}).done(function(data){var el=$section.find(".open-response-assessment-item"),block=el.find(".open-response-assessment-item-block");$section.find(".open-response-assessment-msg").hide(),el.show(),self.renderBreadcrumbs(),block.html(data.html),XBlock.initializeBlock($(block).find(".xblock")[0]),defer.resolve()}).fail(function(data,textStatus){$section.find(".open-response-assessment-item").show(),$section.find(".open-response-assessment-msg").text(gettext("Block view is unavailable")),self.renderBreadcrumbs(),defer.rejectWith(this,[textStatus])})}).promise()},OpenAssessment.CourseItemsListingView.prototype.renderBreadcrumbs=function(){var $section=this.$section,breadcrumbs=$section.find(".open-response-assessment-item-breadcrumbs"),text=gettext("Back to Full List"),fullListItem=$("<a>",{html:"&larr;&nbsp;"+text,title:text});breadcrumbs.append(fullListItem),fullListItem.on("click",$.proxy(this,"backToOpenResponsesGrid"))},OpenAssessment.CourseItemsListingView.prototype.backToOpenResponsesGrid=function(){var $section=this.$section;$section.find(".open-response-assessment-item-breadcrumbs").empty(),$section.find(".open-response-assessment-item-block").empty(),$section.find(".open-response-assessment-item").hide(),$section.find(".open-response-assessment-msg").text(gettext("Please wait")).show(),this.refreshGrids(!0)}}(OpenAssessment),OpenAssessment.DateTimeFactory=function(element){this.element=element},OpenAssessment.DateTimeFactory.prototype={apply:function(){var dtFactory=this;$(".ora-datetime",this.element).each(function(){dtFactory.elementApply($(this))})},determineContext:function(el){return{datetime:el.data("datetime"),timezone:el.data("timezone"),language:el.data("language"),format:""}},determineDateToken:function(el){var dtFactory=this,dateToken="date";return dtFactory.isValid(el.data("datetoken"))&&(dateToken=el.data("datetoken")),dateToken},elementApply:function(el){var dtFactory=this;(function(require){require(["jquery","edx-ui-toolkit/js/utils/date-utils","edx-ui-toolkit/js/utils/string-utils"],function($,DateUtils,StringUtils){var context,localTimeString,displayDatetime,interpolateDict={};dtFactory.isValid(el.data("datetime"))?(context=dtFactory.determineContext(el),dtFactory.isValid(el.data("format"))&&(context.format=DateUtils.dateFormatEnum[el.data("format")]),localTimeString=DateUtils.localize(context),interpolateDict[dtFactory.determineDateToken(el)]=localTimeString,displayDatetime=dtFactory.isValid(el.data("string"))?StringUtils.interpolate(el.data("string"),interpolateDict):localTimeString):displayDatetime=StringUtils.interpolate(el.data("string"),interpolateDict),el.text(displayDatetime)})}).call(this,require||RequireJS.require)},isValid:function(candidateVariable){return void 0!==candidateVariable&&""!==candidateVariable&&"Invalid date"!==candidateVariable&&"None"!==candidateVariable}},OpenAssessment.FileUploader=function(){this.upload=function(url,file){return $.Deferred(function(defer){$.ajax({url:url,type:"PUT",data:file,async:!1,processData:!1,contentType:file.type}).done(function(){Logger.log("openassessment.upload_file",{fileName:file.name,fileSize:file.size,fileType:file.type}),defer.resolve()}).fail(function(data,textStatus){defer.rejectWith(this,[textStatus])})}).promise()}},OpenAssessment.GradeView=function(element,server,baseView){this.element=element,this.server=server,this.baseView=baseView,this.announceStatus=!1,this.isRendering=!1,this.dateFactory=new OpenAssessment.DateTimeFactory(this.element)},OpenAssessment.GradeView.prototype={load:function(usageID){var view=this,baseView=this.baseView,stepID=".step--grade",focusID="[id='oa_grade_"+usageID+"']";view.isRendering=!0,this.server.render("grade").done(function(html){$(stepID,view.element).replaceWith(html),view.server.renderLatex($(stepID,view.element)),view.isRendering=!1,view.installHandlers(),view.baseView.announceStatusChangeToSRandFocus(stepID,usageID,!0,view,focusID),view.dateFactory.apply()}).fail(function(errMsg){baseView.showLoadError("grade",errMsg)})},installHandlers:function(){var sel=$(".step--grade",this.element);this.baseView.setUpCollapseExpand(sel);var view=this;sel.find(".feedback__submit").click(function(eventObject){eventObject.preventDefault(),view.submitFeedbackOnAssessment()})},feedbackText:function(text){var usageID=this.baseView.getUsageID()||"";if(void 0===text)return $("[id='feedback__remarks__value__"+usageID+"']",this.element).val();$("[id='feedback__remarks__value__"+usageID+"']",this.element).val(text)},feedbackOptions:function(options){var view=this,usageID=this.baseView.getUsageID()||"";if(void 0===options)return $.map($(".feedback__overall__value:checked",view.element),function(element){return $(element).val()});$(".feedback__overall__value",this.element).prop("checked",!1),$.each(options,function(index,opt){$("[id='feedback__overall__value--"+opt+"__"+usageID+"']",view.element).prop("checked",!0)})},setHidden:function(selector,hidden){selector.toggleClass("is--hidden",hidden),selector.attr("aria-hidden",hidden?"true":"false")},isHidden:function(selector){return selector.hasClass("is--hidden")&&"true"===selector.attr("aria-hidden")},feedbackState:function(newState){var containerSel=$(".submission__feedback__content",this.element),instructionsSel=containerSel.find(".submission__feedback__instructions"),fieldsSel=containerSel.find(".submission__feedback__fields"),actionsSel=containerSel.find(".submission__feedback__actions"),transitionSel=containerSel.find(".transition__status"),messageSel=containerSel.find(".message--complete");if(void 0===newState){var isSubmitting=containerSel.hasClass("is--transitioning")&&containerSel.hasClass("is--submitting")&&!this.isHidden(transitionSel)&&this.isHidden(messageSel)&&this.isHidden(instructionsSel)&&this.isHidden(fieldsSel)&&this.isHidden(actionsSel),hasSubmitted=containerSel.hasClass("is--submitted")&&this.isHidden(transitionSel)&&!this.isHidden(messageSel)&&this.isHidden(instructionsSel)&&this.isHidden(fieldsSel)&&this.isHidden(actionsSel);if(!containerSel.hasClass("is--submitted")&&!containerSel.hasClass("is--transitioning")&&!containerSel.hasClass("is--submitting")&&this.isHidden(transitionSel)&&this.isHidden(messageSel)&&!this.isHidden(instructionsSel)&&!this.isHidden(fieldsSel)&&!this.isHidden(actionsSel))return"open";if(isSubmitting)return"submitting";if(hasSubmitted)return"submitted";throw"Invalid feedback state"}"open"===newState?(containerSel.toggleClass("is--transitioning",!1),containerSel.toggleClass("is--submitting",!1),containerSel.toggleClass("is--submitted",!1),this.setHidden(instructionsSel,!1),this.setHidden(fieldsSel,!1),this.setHidden(actionsSel,!1),this.setHidden(transitionSel,!0),this.setHidden(messageSel,!0)):"submitting"===newState?(containerSel.toggleClass("is--transitioning",!0),containerSel.toggleClass("is--submitting",!0),containerSel.toggleClass("is--submitted",!1),this.setHidden(instructionsSel,!0),this.setHidden(fieldsSel,!0),this.setHidden(actionsSel,!0),this.setHidden(transitionSel,!1),this.setHidden(messageSel,!0)):"submitted"===newState&&(containerSel.toggleClass("is--transitioning",!1),containerSel.toggleClass("is--submitting",!1),containerSel.toggleClass("is--submitted",!0),this.setHidden(instructionsSel,!0),this.setHidden(fieldsSel,!0),this.setHidden(actionsSel,!0),this.setHidden(transitionSel,!0),this.setHidden(messageSel,!1))},submitFeedbackOnAssessment:function(){var view=this,baseView=this.baseView;$(".feedback__submit",this.element).prop("disabled",!0),view.feedbackState("submitting"),this.server.submitFeedbackOnAssessment(this.feedbackText(),this.feedbackOptions()).done(function(){view.feedbackState("submitted")}).fail(function(errMsg){baseView.toggleActionError("feedback_assess",errMsg)})}},OpenAssessment.LeaderboardView=function(element,server,baseView){this.element=element,this.server=server,this.baseView=baseView},OpenAssessment.LeaderboardView.prototype={load:function(usageID){var view=this,baseView=this.baseView,stepID=".step--leaderboard";this.server.render("leaderboard").done(function(html){$(stepID,view.element).replaceWith(html),view.server.renderLatex($(stepID,view.element)),view.installHandlers(),void 0!==usageID&&$(stepID,view.element).hasClass("is--showing")&&$("[id='oa_leaderboard_"+usageID+"']",view.element).focus()}).fail(function(errMsg){baseView.showLoadError("leaderboard",errMsg)})},installHandlers:function(){this.baseView.setUpCollapseExpand($(".step--leaderboard",this.element))}},OpenAssessment.MessageView=function(element,server,baseView){this.element=element,this.server=server,this.baseView=baseView},OpenAssessment.MessageView.prototype={load:function(){var view=this,baseView=this.baseView;this.server.render("message").done(function(html){$(".openassessment__message",view.element).replaceWith(html),
view.server.renderLatex($(".openassessment__message",view.element))}).fail(function(errMsg){baseView.showLoadError("message",errMsg)})}},OpenAssessment.PeerView=function(element,server,baseView){this.element=element,this.server=server,this.baseView=baseView,this.rubric=null,this.isRendering=!1,this.announceStatus=!1,this.dateFactory=new OpenAssessment.DateTimeFactory(this.element)},OpenAssessment.PeerView.prototype={UNSAVED_WARNING_KEY:"peer-assessment",load:function(usageID){var view=this,stepID=".step--peer-assessment",focusID="[id='oa_peer_"+usageID+"']";view.isRendering=!0,this.server.render("peer_assessment").done(function(html){$(stepID,view.element).replaceWith(html),view.isRendering=!1,view.server.renderLatex($(stepID,view.element)),view.installHandlers(!1),view.baseView.announceStatusChangeToSRandFocus(stepID,usageID,!1,view,focusID),view.announceStatus=!1,view.dateFactory.apply()}).fail(function(){view.baseView.showLoadError("peer-assessment")}),view.baseView.loadMessageView()},loadContinuedAssessment:function(usageID){var view=this,focusID="[id='oa_peer_"+usageID+"']";view.continueAssessmentEnabled(!1),view.isRendering=!0,this.server.renderContinuedPeer().done(function(html){$(".step--peer-assessment",view.element).replaceWith(html),view.server.renderLatex($(".step--peer-assessment",view.element)),view.isRendering=!1,view.installHandlers(!0),view.baseView.announceStatusChangeToSRandFocus(".step--peer-assessment",usageID,!1,view,focusID)}).fail(function(){view.baseView.showLoadError("peer-assessment"),view.continueAssessmentEnabled(!0)})},continueAssessmentEnabled:function(enabled){return this.baseView.buttonEnabled(".action--continue--grading",enabled)},installHandlers:function(isContinuedAssessment){var sel=$(".step--peer-assessment",this.element),view=this;this.baseView.setUpCollapseExpand(sel),this.baseView.bindLatexPreview(sel);var rubricSelector=$(".peer-assessment--001__assessment",this.element);if(rubricSelector.size()>0){var rubricElement=rubricSelector.get(0);this.rubric=new OpenAssessment.Rubric(rubricElement)}else this.rubric=null;null!==this.rubric&&(this.rubric.canSubmitCallback($.proxy(view.peerSubmitEnabled,view)),this.rubric.changesExistCallback($.proxy(view.assessmentRubricChanges,view))),sel.find(".peer-assessment--001__assessment__submit").click(function(eventObject){eventObject.preventDefault(),view.announceStatus=!0,isContinuedAssessment?view.continuedPeerAssess():view.peerAssess()}),sel.find(".action--continue--grading").click(function(eventObject){eventObject.preventDefault(),view.loadContinuedAssessment(view.baseView.getUsageID())})},peerSubmitEnabled:function(enabled){return this.baseView.buttonEnabled(".peer-assessment--001__assessment__submit",enabled)},assessmentRubricChanges:function(changesExist){changesExist&&this.baseView.unsavedWarningEnabled(!0,this.UNSAVED_WARNING_KEY,gettext("If you leave this page without submitting your peer assessment, you will lose any work you have done."))},peerAssess:function(){var view=this,baseView=view.baseView,usageID=baseView.getUsageID();this.peerAssessRequest(function(){baseView.unsavedWarningEnabled(!1,view.UNSAVED_WARNING_KEY),baseView.loadAssessmentModules(usageID),baseView.scrollToTop(".step--peer-assessment")})},continuedPeerAssess:function(){var view=this,gradeView=this.baseView.gradeView,baseView=view.baseView,usageID=baseView.getUsageID();view.peerAssessRequest(function(){baseView.unsavedWarningEnabled(!1,view.UNSAVED_WARNING_KEY),view.loadContinuedAssessment(usageID),gradeView.load(),baseView.scrollToTop(".step--peer-assessment")})},peerAssessRequest:function(successFunction){var view=this,uuid=this.getUUID();view.baseView.toggleActionError("peer",null),view.peerSubmitEnabled(!1),this.server.peerAssess(this.rubric.optionsSelected(),this.rubric.criterionFeedback(),this.rubric.overallFeedback(),uuid).done(successFunction).fail(function(errMsg){view.baseView.toggleActionError("peer",errMsg),view.peerSubmitEnabled(!0)})},getUUID:function(){return $("div[data-usage-id='"+this.baseView.getUsageID()+"']").find(".step--peer-assessment").data("submission-uuid")}},OpenAssessment.ResponseView=function(element,server,fileUploader,baseView,data){this.element=element,this.server=server,this.fileUploader=fileUploader,this.baseView=baseView,this.savedResponse=[],this.textResponse="required",this.fileUploadResponse="",this.files=null,this.filesDescriptions=[],this.filesType=null,this.lastChangeTime=Date.now(),this.errorOnLastSave=!1,this.autoSaveTimerId=null,this.data=data,this.filesUploaded=!1,this.announceStatus=!1,this.isRendering=!1,this.dateFactory=new OpenAssessment.DateTimeFactory(this.element)},OpenAssessment.ResponseView.prototype={AUTO_SAVE_POLL_INTERVAL:2e3,AUTO_SAVE_WAIT:3e4,MAX_FILES_SIZE:10485760,UNSAVED_WARNING_KEY:"learner-response",load:function(usageID){var view=this,stepID=".step--response",focusID="[id='oa_response_"+usageID+"']";view.isRendering=!0,this.server.render("submission").done(function(html){$(stepID,view.element).replaceWith(html),view.server.renderLatex($(stepID,view.element)),view.installHandlers(),view.setAutoSaveEnabled(!0),view.isRendering=!1,view.baseView.announceStatusChangeToSRandFocus(stepID,usageID,!1,view,focusID),view.announceStatus=!1,view.dateFactory.apply()}).fail(function(){view.baseView.showLoadError("response")})},installHandlers:function(){var sel=$(".step--response",this.element),view=this,uploadType="";sel.find(".submission__answer__display__file").length&&(uploadType=sel.find(".submission__answer__display__file").data("upload-type")),this.baseView.setUpCollapseExpand(sel),this.savedResponse=this.response();var handleChange=function(){view.handleResponseChanged()};sel.find(".submission__answer__part__text__value").on("change keyup drop paste",handleChange);var handlePrepareUpload=function(eventData){view.prepareUpload(eventData.target.files,uploadType)};sel.find("input[type=file]").on("change",handlePrepareUpload);var submit=$(".step--response__submit",this.element);this.textResponse=$(submit).attr("text_response"),this.fileUploadResponse=$(submit).attr("file_upload_response"),sel.find(".step--response__submit").click(function(eventObject){eventObject.preventDefault(),view.submit()}),sel.find(".submission__save").click(function(eventObject){eventObject.preventDefault(),view.save()}),this.baseView.bindLatexPreview(sel),sel.find(".file__upload").click(function(eventObject){eventObject.preventDefault();var previouslyUploadedFiles=!!sel.find(".submission__answer__file").length;if($(".submission__answer__display__file",view.element).removeClass("is--hidden"),previouslyUploadedFiles){var msg=gettext("After you upload new files all your previously uploaded files will be overwritten. Continue?");confirm(msg)&&view.uploadFiles()}else view.uploadFiles()})},setAutoSaveEnabled:function(enabled){enabled?null===this.autoSaveTimerId&&(this.autoSaveTimerId=setInterval($.proxy(this.autoSave,this),this.AUTO_SAVE_POLL_INTERVAL)):null!==this.autoSaveTimerId&&clearInterval(this.autoSaveTimerId)},checkSubmissionAbility:function(filesFiledIsNotBlank){var textFieldsIsNotBlank=!this.response().every(function(element){return""===$.trim(element)});filesFiledIsNotBlank=filesFiledIsNotBlank||!1,$(".submission__answer__file",this.element).each(function(){"IMG"===$(this).prop("tagName")&&""!==$(this).attr("src")&&(filesFiledIsNotBlank=!0),"A"===$(this).prop("tagName")&&""!==$(this).attr("href")&&(filesFiledIsNotBlank=!0)});var readyToSubmit=!0;"required"!==this.textResponse||textFieldsIsNotBlank||(readyToSubmit=!1),"required"!==this.fileUploadResponse||filesFiledIsNotBlank||(readyToSubmit=!1),"optional"!==this.textResponse||"optional"!==this.fileUploadResponse||textFieldsIsNotBlank||filesFiledIsNotBlank||(readyToSubmit=!1),this.submitEnabled(readyToSubmit)},checkSaveAbility:function(){var textFieldsIsNotBlank=!this.response().every(function(element){return""===$.trim(element)});return!("required"===this.textResponse&&!textFieldsIsNotBlank)},submitEnabled:function(enabled){return this.baseView.buttonEnabled(".step--response__submit",enabled)},saveEnabled:function(enabled){return this.baseView.buttonEnabled(".submission__save",enabled)},previewEnabled:function(enabled){return this.baseView.buttonEnabled(".submission__preview",enabled)},saveStatus:function(msg){var sel=$(".save__submission__label",this.element);if(void 0===msg)return sel.text();var label=gettext("Status of Your Response");sel.html('<span class="sr">'+_.escape(label)+":</span>\n"+msg)},response:function(texts){var sel=$(".response__submission .submission__answer__part__text__value",this.element);if(void 0===texts)return sel.map(function(){return $.trim($(this).val())}).get();sel.map(function(index){$(this).val(texts[index])})},responseChanged:function(){var savedResponse=this.savedResponse;return this.response().some(function(element,index){return element!==savedResponse[index]})},autoSave:function(){var timeSinceLastChange=Date.now()-this.lastChangeTime;this.responseChanged()&&timeSinceLastChange>this.AUTO_SAVE_WAIT&&!this.errorOnLastSave&&this.save()},handleResponseChanged:function(){if(this.checkSubmissionAbility(),this.responseChanged()){var saveAbility=this.checkSaveAbility();this.saveEnabled(saveAbility),this.previewEnabled(saveAbility),this.saveStatus(gettext("This response has not been saved.")),this.baseView.unsavedWarningEnabled(!0,this.UNSAVED_WARNING_KEY,gettext("If you leave this page without saving or submitting your response, you will lose any work you have done on the response."))}this.lastChangeTime=Date.now()},save:function(){this.errorOnLastSave=!1,this.saveStatus(gettext("Saving...")),this.baseView.toggleActionError("save",null),this.baseView.unsavedWarningEnabled(!1,this.UNSAVED_WARNING_KEY);var view=this,savedResponse=this.response();this.server.save(savedResponse).done(function(){if(view.savedResponse=savedResponse,view.checkSubmissionAbility(),view.response().every(function(element,index){return element===savedResponse[index]})){view.saveEnabled(!1);var msg=gettext("This response has been saved but not submitted.");view.saveStatus(msg),view.baseView.srReadTexts([msg])}}).fail(function(errMsg){view.saveStatus(gettext("Error")),view.baseView.toggleActionError("save",errMsg),view.errorOnLastSave=!0})},submit:function(){this.submitEnabled(!1);var view=this,baseView=this.baseView,fileDefer=$.Deferred();if(null===view.files||view.filesUploaded)fileDefer.resolve();else{var msg=gettext("Do you want to upload your file before submitting?");if(!confirm(msg))return void view.submitEnabled(!0);if(!1===(fileDefer=view.uploadFiles()))return}fileDefer.pipe(function(){return view.confirmSubmission().pipe(function(){var submission=view.response();return baseView.toggleActionError("response",null),view.server.submit(submission)})}).done($.proxy(view.moveToNextStep,view)).fail(function(errCode,errMsg){"ENOMULTI"===errCode?view.moveToNextStep():(errMsg&&baseView.toggleActionError("submit",errMsg),view.submitEnabled(!0))})},moveToNextStep:function(){var baseView=this.baseView,usageID=baseView.getUsageID(),view=this;this.load(usageID),baseView.loadAssessmentModules(usageID),view.announceStatus=!0,baseView.unsavedWarningEnabled(!1,this.UNSAVED_WARNING_KEY)},confirmSubmission:function(){var msg=gettext("You're about to submit your response for this assignment. After you submit this response, you can't change it or submit a new response.");return $.Deferred(function(defer){confirm(msg)?defer.resolve():defer.reject()})},prepareUpload:function(files,uploadType,descriptions){this.files=null,this.filesType=uploadType,this.filesUploaded=!1;for(var totalSize=0,ext=null,fileType=null,errorCheckerTriggered=!1,sel=$(".step--response",this.element),i=0;i<files.length;i++){if(totalSize+=files[i].size,ext=files[i].name.split(".").pop().toLowerCase(),fileType=files[i].type,files[i].name,totalSize>this.MAX_FILES_SIZE){this.baseView.toggleActionError("upload",gettext("File size must be 10MB or less.")),errorCheckerTriggered=!0;break}if("image"===uploadType&&-1===this.data.ALLOWED_IMAGE_MIME_TYPES.indexOf(fileType)){this.baseView.toggleActionError("upload",gettext("You can upload files with these file types: ")+"JPG, PNG or GIF"),errorCheckerTriggered=!0;break}if("pdf-and-image"===uploadType&&-1===this.data.ALLOWED_FILE_MIME_TYPES.indexOf(fileType)){this.baseView.toggleActionError("upload",gettext("You can upload files with these file types: ")+"JPG, PNG, GIF or PDF"),errorCheckerTriggered=!0;break}if("custom"===uploadType&&-1===this.data.FILE_TYPE_WHITE_LIST.indexOf(ext)){this.baseView.toggleActionError("upload",gettext("You can upload files with these file types: ")+this.data.FILE_TYPE_WHITE_LIST.join(", ")),errorCheckerTriggered=!0;break}if(-1!==this.data.FILE_EXT_BLACK_LIST.indexOf(ext)){this.baseView.toggleActionError("upload",gettext("File type is not allowed.")),errorCheckerTriggered=!0;break}}errorCheckerTriggered||(this.baseView.toggleActionError("upload",null),this.files=files,this.updateFilesDescriptionsFields(files,descriptions,uploadType)),null===this.files&&sel.find(".file__upload").prop("disabled",!0)},updateFilesDescriptionsFields:function(files,descriptions,uploadType){var filesDescriptions=$(this.element).find(".files__descriptions").first(),mainDiv=null,divLabel=null,divTextarea=null,divImage=null,img=null,textarea=null,descriptionsExists=!0;this.filesDescriptions=descriptions||[],$(filesDescriptions).show().html("");for(var i=0;i<files.length;i++)mainDiv=$("<div/>"),divLabel=$("<div/>"),divLabel.addClass("submission__file__description__label"),divLabel.text(gettext("Describe ")+files[i].name+" "+gettext("(required):")),divLabel.appendTo(mainDiv),divTextarea=$("<div/>"),divTextarea.addClass("submission__file__description"),textarea=$("<textarea />",{"aria-label":gettext("Describe ")+files[i].name}),-1!==this.filesDescriptions.indexOf(i)&&""!==this.filesDescriptions[i]?textarea.val(this.filesDescriptions[i]):descriptionsExists=!1,textarea.addClass("file__description file__description__"+i),textarea.appendTo(divTextarea),"image"===uploadType&&(img=$("<img/>",{src:window.URL.createObjectURL(files[i]),height:80,alt:gettext("Thumbnail view of ")+files[i].name}),img.onload=function(){window.URL.revokeObjectURL(this.src)},divImage=$("<div/>"),divImage.addClass("submission__img__preview"),img.appendTo(divImage),divImage.appendTo(mainDiv)),divTextarea.appendTo(mainDiv),mainDiv.appendTo(filesDescriptions),textarea.on("change keyup drop paste",$.proxy(this,"checkFilesDescriptions"));$(this.element).find(".file__upload").prop("disabled",!descriptionsExists)},checkFilesDescriptions:function(){var isError=!1,filesDescriptions=[];$(this.element).find(".file__description").each(function(){var filesDescriptionVal=$(this).val();filesDescriptionVal?filesDescriptions.push(filesDescriptionVal):isError=!0}),$(this.element).find(".file__upload").prop("disabled",isError),isError||(this.filesDescriptions=filesDescriptions)},removeFilesDescriptions:function(){var filesDescriptions=$(this.element).find(".files__descriptions").first();$(filesDescriptions).hide().html("")},removeUploadedFiles:function(){var view=this,sel=$(".step--response",this.element);return this.server.removeUploadedFiles().done(function(){$(".step--response",view.element).find(".submission__answer__files").html("")}).fail(function(errMsg){view.baseView.toggleActionError("upload",errMsg),sel.find(".file__upload").prop("disabled",!1)})},saveFilesDescriptions:function(){var view=this,sel=$(".step--response",this.element);return this.server.saveFilesDescriptions(this.filesDescriptions).done(function(){view.removeFilesDescriptions()}).fail(function(errMsg){view.baseView.toggleActionError("upload",errMsg),sel.find(".file__upload").prop("disabled",!1)})},uploadFiles:function(){var view=this,promise=null,fileCount=view.files.length;return $(".step--response",this.element).find(".file__upload").prop("disabled",!0),promise=view.removeUploadedFiles(),promise=promise.then(function(){return view.saveFilesDescriptions()}),$.each(view.files,function(index,file){promise=promise.then(function(){return view.fileUpload(view,file.type,file.name,index,file,fileCount===index+1)})}),promise},fileUpload:function(view,filetype,filename,filenum,file,finalUpload){var sel=$(".step--response",this.element),handleError=function(errMsg){view.baseView.toggleActionError("upload",errMsg),sel.find(".file__upload").prop("disabled",!1)};return view.server.getUploadUrl(filetype,filename,filenum).done(function(url){view.fileUploader.upload(url,file).done(function(){view.fileUrl(filenum),view.baseView.toggleActionError("upload",null),finalUpload&&(sel.find("input[type=file]").val(""),view.filesUploaded=!0,view.checkSubmissionAbility(!0))}).fail(handleError)}).fail(handleError)},fileUrl:function(filenum){var view=this,sel=$(".step--response",this.element);view.server.getDownloadUrl(filenum).done(function(url){var className="submission__answer__file__block__"+filenum,file=null,img=null,fileBlock=null,fileBlockExists=!!sel.find("."+className).length,div1=null,div2=null,ariaLabelledBy=null;return fileBlockExists||(fileBlock=$("<div/>"),fileBlock.addClass("submission__answer__file__block "+className),fileBlock.appendTo(sel.find(".submission__answer__files").first())),"image"===view.filesType?(ariaLabelledBy="file_description_"+Math.random().toString(36).substr(2,9),div1=$("<div/>",{id:ariaLabelledBy}),div1.addClass("submission__file__description__label"),div1.text(view.filesDescriptions[filenum]+":"),div1.appendTo(fileBlock),img=$("<img />"),img.addClass("submission__answer__file submission--image"),img.attr("aria-labelledby",ariaLabelledBy),img.attr("src",url),div2=$("<div/>"),div2.html(img),div2.appendTo(fileBlock)):(file=$("<a />",{href:url,text:view.filesDescriptions[filenum]}),file.addClass("submission__answer__file submission--file"),file.attr("target","_blank"),file.appendTo(fileBlock)),url})}},OpenAssessment.Rubric=function(element){this.element=element},OpenAssessment.Rubric.prototype={criterionFeedback:function(criterionFeedback){var feedback={},rubric=this;return $("textarea.answer__value",this.element).each(function(index,sel){var criterionName=rubric.getCriterionName(sel);void 0!==criterionFeedback?($(sel).val(criterionFeedback[criterionName]),feedback[criterionName]=criterionFeedback[criterionName]):feedback[criterionName]=$(sel).val()}),feedback},overallFeedback:function(overallFeedback){var selector=".assessment__rubric__question--feedback__value";if(void 0===overallFeedback)return $(selector,this.element).val();$(selector,this.element).val(overallFeedback)},optionsSelected:function(optionsSelected){var selector="input[type=radio]",rubric=this;if(void 0===optionsSelected){var options={};return $(selector+":checked",this.element).each(function(index,sel){options[rubric.getCriterionName(sel)]=sel.value}),options}$(selector,this.element).prop("checked",!1),$(selector,this.element).each(function(index,sel){var criterionName=rubric.getCriterionName(sel);optionsSelected.hasOwnProperty(criterionName)&&sel.value===optionsSelected[criterionName]&&$(sel).prop("checked",!0)})},canSubmitCallback:function(callback){var rubric=this;callback(rubric.canSubmit()),$(this.element).on("change keyup drop paste",function(){callback(rubric.canSubmit())})},canSubmit:function(){var numChecked=$("input[type=radio]:checked",this.element).length,numAvailable=$(".field--radio.assessment__rubric__question.has--options",this.element).length,completedRequiredComments=!0;return $("textarea[required]",this.element).each(function(){""===$.trim($(this).val())&&(completedRequiredComments=!1)}),numChecked===numAvailable&&completedRequiredComments},changesExistCallback:function(callback){var rubric=this;callback(rubric.changesExist()),$(this.element).on("change keyup drop paste",function(){callback(rubric.changesExist())})},changesExist:function(){var numChecked=$("input[type=radio]:checked",this.element).length,textExists=!1;return $("textarea",this.element).each(function(){""!==$.trim($(this).val())&&(textExists=!0)}),numChecked>0||textExists},showCorrections:function(corrections){var hasErrors=!1,rubric=this;return $("input[type=radio]",this.element).each(function(index,sel){var listItem=$(sel).parents(".assessment__rubric__question");corrections.hasOwnProperty(rubric.getCriterionName(sel))?(hasErrors=!0,listItem.find(".message--incorrect").removeClass("is--hidden"),listItem.find(".message--correct").addClass("is--hidden")):(listItem.find(".message--correct").removeClass("is--hidden"),listItem.find(".message--incorrect").addClass("is--hidden"))}),hasErrors},getCriterionName:function(element){return $(element).data("criterion-name")}},OpenAssessment.SelfView=function(element,server,baseView){this.element=element,this.server=server,this.baseView=baseView,this.rubric=null,this.isRendering=!1,this.announceStatus=!1,this.dateFactory=new OpenAssessment.DateTimeFactory(this.element)},OpenAssessment.SelfView.prototype={UNSAVED_WARNING_KEY:"self-assessment",load:function(usageID){var view=this,stepID=".step--self-assessment",focusID="[id='oa_self_"+usageID+"']";view.isRendering=!0,this.server.render("self_assessment").done(function(html){$(stepID,view.element).replaceWith(html),view.isRendering=!1,view.server.renderLatex($(stepID,view.element)),view.installHandlers(),view.baseView.announceStatusChangeToSRandFocus(stepID,usageID,!1,view,focusID),view.dateFactory.apply()}).fail(function(){view.showLoadError("self-assessment")})},installHandlers:function(){var view=this,sel=$(".step--self-assessment",view.element);this.baseView.setUpCollapseExpand(sel),this.baseView.bindLatexPreview(sel);var rubricSelector=$(".self-assessment--001__assessment",this.element);if(rubricSelector.size()>0){var rubricElement=rubricSelector.get(0);this.rubric=new OpenAssessment.Rubric(rubricElement)}else this.rubric=null;null!==this.rubric&&(this.rubric.canSubmitCallback($.proxy(this.selfSubmitEnabled,this)),this.rubric.changesExistCallback($.proxy(this.assessmentRubricChanges,this))),sel.find(".self-assessment--001__assessment__submit").click(function(eventObject){eventObject.preventDefault(),view.selfAssess()})},selfSubmitEnabled:function(enabled){return this.baseView.buttonEnabled(".self-assessment--001__assessment__submit",enabled)},assessmentRubricChanges:function(changesExist){changesExist&&this.baseView.unsavedWarningEnabled(!0,this.UNSAVED_WARNING_KEY,gettext("If you leave this page without submitting your self assessment, you will lose any work you have done."))},selfAssess:function(){var view=this,baseView=this.baseView,usageID=baseView.getUsageID();baseView.toggleActionError("self",null),view.selfSubmitEnabled(!1),this.server.selfAssess(this.rubric.optionsSelected(),this.rubric.criterionFeedback(),this.rubric.overallFeedback()).done(function(){baseView.unsavedWarningEnabled(!1,view.UNSAVED_WARNING_KEY),view.announceStatus=!0,baseView.loadAssessmentModules(usageID)}).fail(function(errMsg){baseView.toggleActionError("self",errMsg),view.selfSubmitEnabled(!0)})}},OpenAssessment.StaffView=function(element,server,baseView){this.element=element,this.server=server,this.baseView=baseView,this.isRendering=!1,this.announceStatus=!1},OpenAssessment.StaffView.prototype={load:function(usageID){var view=this,focusID="[id='oa_staff_grade_"+usageID+"']";view.isRendering=!0,this.server.render("staff_assessment").done(function(html){$(".step--staff-assessment",view.element).replaceWith(html),view.isRendering=!1,view.installHandlers(),view.baseView.announceStatusChangeToSRandFocus(".step--staff-assessment",usageID,!1,view,focusID)}).fail(function(){view.baseView.showLoadError("staff-assessment")})},installHandlers:function(){this.baseView.setUpCollapseExpand($(".step--staff-assessment",this.element))}},function(OpenAssessment){"use strict";OpenAssessment.StaffAreaView=function(element,server,baseView){this.element=element,this.server=server,this.baseView=baseView},OpenAssessment.StaffAreaView.prototype={FULL_GRADE_UNSAVED_WARNING_KEY:"staff-grade",OVERRIDE_UNSAVED_WARNING_KEY:"staff-override",load:function(){var view=this;$(".openassessment__staff-area",view.element).length>0&&this.server.render("staff_area").done(function(html){$(".openassessment__staff-area",view.element).replaceWith(html),view.server.renderLatex($(".openassessment__staff-area",view.element)),view.installHandlers()}).fail(function(){view.baseView.showLoadError("staff_area")})},loadStudentInfo:function(classToExpand){var view=this,$manageLearnersTab=$(".openassessment__staff-tools",this.element),$form=$manageLearnersTab.find(".openassessment_student_info_form"),studentUsername=$manageLearnersTab.find(".openassessment__student_username").val(),showFormError=function(errorMessage){$form.find(".form--error").text(errorMessage).focus()},deferred=$.Deferred();return $(".openassessment__student-info",view.element).text(""),studentUsername.trim()?this.server.studentInfo(studentUsername).done(function(html){showFormError(""),$(".openassessment__student-info",view.element).replaceWith(html),$manageLearnersTab.on("click",".action--submit-cancel-submission",function(eventObject){eventObject.preventDefault(),view.cancelSubmission($(this).data("submission-uuid"))});var handleChange=function(eventData){view.handleCommentChanged(eventData)};$manageLearnersTab.find(".cancel_submission_comments").on("change keyup drop paste",handleChange);var $rubric=$manageLearnersTab.find(".staff-assessment__assessment");if($rubric.size()>0){var rubricElement=$rubric.get(0),rubric=new OpenAssessment.Rubric(rubricElement);rubric.canSubmitCallback($.proxy(view.staffSubmitEnabled,view,$manageLearnersTab)),rubric.changesExistCallback($.proxy(view.assessmentRubricChanges,view,view.OVERRIDE_UNSAVED_WARNING_KEY)),$manageLearnersTab.find(".wrapper--staff-assessment .action--submit",view.element).click(function(eventObject){var target=$(eventObject.currentTarget),rootElement=target.closest(".openassessment__student-info"),submissionID=rootElement.data("submission-uuid");eventObject.preventDefault(),view.submitStaffOverride(submissionID,rubric,$manageLearnersTab)})}view.baseView.setUpCollapseExpand($manageLearnersTab),$manageLearnersTab.find(".staff-info__student__report__summary").focus(),classToExpand&&($manageLearnersTab.find("."+classToExpand+" ."+view.baseView.SLIDABLE_CONTENT_CLASS).slideDown(),$manageLearnersTab.find("."+classToExpand+" ."+view.baseView.SLIDABLE_CLASS).addClass(view.baseView.IS_SHOWING_CLASS).attr("aria-expanded","true").focus()),deferred.resolve()}).fail(function(){showFormError(gettext("Unexpected server error.")),deferred.reject()}):(showFormError(gettext("You must provide a learner name.")),deferred.reject()),deferred.promise()},loadStaffGradeForm:function(){var view=this,$staffGradeTab=$(".openassessment__staff-grading",this.element),$staffGradeControl=$staffGradeTab.find("."+view.baseView.SLIDABLE_CLASS),$staffGradeContent=$staffGradeTab.find("."+view.baseView.SLIDABLE_CONTENT_CLASS),$staffGradeContainer=$staffGradeTab.find("."+view.baseView.SLIDABLE_CONTAINER_CLASS),deferred=$.Deferred(),showFormError=function(errorMessage){$staffGradeTab.find(".staff__grade__form--error").text(errorMessage).focus()};return $staffGradeControl.attr("aria-expanded","true"),this.staffGradeFormLoaded?($staffGradeContent.slideDown(),$staffGradeContainer.addClass(view.baseView.IS_SHOWING_CLASS),deferred.resolve()):(this.staffGradeFormLoaded=!0,this.server.staffGradeForm().done(function(html){showFormError(""),$staffGradeTab.find(".staff__grade__form").replaceWith(html),view.updateStaffGradeCounts();var $rubric=$staffGradeTab.find(".staff-assessment__assessment");if($rubric.size()>0){var rubricElement=$rubric.get(0),rubric=new OpenAssessment.Rubric(rubricElement);rubric.canSubmitCallback($.proxy(view.staffSubmitEnabled,view,$staffGradeTab)),rubric.changesExistCallback($.proxy(view.assessmentRubricChanges,view,view.FULL_GRADE_UNSAVED_WARNING_KEY)),$staffGradeTab.find(".wrapper--staff-assessment .action--submit").click(function(eventObject){var submissionID=$staffGradeTab.find(".staff__grade__form").data("submission-uuid");eventObject.preventDefault(),view.submitStaffGrade(submissionID,rubric,$staffGradeTab,$(eventObject.currentTarget).hasClass("continue_grading--action"))})}$staffGradeContent.slideDown(function(){$staffGradeControl.focus(),view.baseView.setUpCollapseExpand($(".staff__grade__form",view.element))}),$staffGradeContainer.addClass(view.baseView.IS_SHOWING_CLASS),deferred.resolve()}).fail(function(){showFormError(gettext("Unexpected server error.")),view.staffGradeFormLoaded=!1,deferred.reject()})),deferred.promise()},closeStaffGradeForm:function(clear){var view=this,$staffGradeTab=$(".openassessment__staff-grading",view.element),$staffGradeControl=$staffGradeTab.find("."+view.baseView.SLIDABLE_CLASS).first(),$staffGradeContent=$staffGradeTab.find("."+view.baseView.SLIDABLE_CONTENT_CLASS),$staffGradeContainer=$staffGradeTab.find("."+view.baseView.SLIDABLE_CONTAINER_CLASS);$staffGradeControl.attr("aria-expanded","false"),clear?($staffGradeTab.find(".staff__grade__form").replaceWith('<div class="staff__grade__form"></div>'),this.updateStaffGradeCounts()):$staffGradeContent.slideUp(),$staffGradeContainer.removeClass(view.baseView.IS_SHOWING_CLASS),$staffGradeControl.focus()},updateStaffGradeCounts:function(){var view=this,$staffGradeTab=$(".openassessment__staff-grading",this.element);view.server.staffGradeCounts().done(function(html){$staffGradeTab.find(".staff__grade__status").replaceWith(html)}).fail(function(){$staffGradeTab.find(".staff__grade__status").replaceWith('<span class="staff__grade__status"><span class="staff__grade__value"><span class="copy">'+gettext("Error getting the number of ungraded responses")+"</span></span></span>")})},installHandlers:function(){var view=this,$staffArea=$(".openassessment__staff-area",this.element),$manageLearnersTab=$(".openassessment__staff-tools",$staffArea),$staffGradeTool=$(".openassessment__staff-grading",$staffArea);$staffArea.length<=0||($staffArea.find(".ui-staff__button").click(function(eventObject){$staffArea.find(".ui-staff__button").each(function(index,button){if(button!==eventObject.currentTarget){$staffArea.find("."+$(button).data("panel")).first().slideUp(0)}});var $button=$(eventObject.currentTarget),$panel=$staffArea.find("."+$button.data("panel")).first();$button.hasClass("is--active")?($button.removeClass("is--active").attr("aria-expanded","false"),$panel.slideUp()):($staffArea.find(".ui-staff__button").removeClass("is--active").attr("aria-expanded","false"),$button.addClass("is--active").attr("aria-expanded","true"),$panel.slideDown()),$panel.find(".ui-staff_close_button").focus()}),$staffArea.find(".ui-staff_close_button").click(function(eventObject){var $button=$(eventObject.currentTarget),$panel=$button.closest(".wrapper--ui-staff");$staffArea.find(".ui-staff__button").removeClass("is--active").attr("aria-expanded","false"),$panel.slideUp(),$staffArea.find(".ui-staff__button").each(function(index,button){$staffArea.find("."+$(button).data("panel")).first()[0]===$panel[0]&&$(button).focus()})}),$manageLearnersTab.find(".openassessment_student_info_form").submit(function(eventObject){eventObject.preventDefault(),view.loadStudentInfo()}),$manageLearnersTab.find(".action--submit-username").click(function(eventObject){eventObject.preventDefault(),view.loadStudentInfo()}),$manageLearnersTab.find(".action--submit-training").click(function(eventObject){eventObject.preventDefault(),view.scheduleTraining()}),$manageLearnersTab.find(".action--submit-unfinished-tasks").click(function(eventObject){eventObject.preventDefault(),view.rescheduleUnfinishedTasks()}),$staffGradeTool.find(".staff__grade__show-form").click(function(event){$(event.currentTarget).closest("."+view.baseView.SLIDABLE_CONTAINER_CLASS).hasClass(view.baseView.IS_SHOWING_CLASS)?view.closeStaffGradeForm(!1):view.loadStaffGradeForm()}))},scheduleTraining:function(){var view=this;this.server.scheduleTraining().done(function(msg){
$(".schedule_training_message",view.element).text(msg)}).fail(function(errMsg){$(".schedule_training_message",view.element).text(errMsg)})},rescheduleUnfinishedTasks:function(){var view=this;this.server.rescheduleUnfinishedTasks().done(function(msg){$(".reschedule_unfinished_tasks_message",view.element).text(msg)}).fail(function(errMsg){$(".reschedule_unfinished_tasks_message",view.element).text(errMsg)})},cancelSubmission:function(submissionUUID){this.cancelSubmissionEnabled(!1);var view=this,comments=$(".cancel_submission_comments",this.element).val();this.server.cancelSubmission(submissionUUID,comments).done(function(){view.loadStudentInfo("staff-info__student__grade")}).fail(function(errorMessage){$(".cancel-submission-error").html(_.escape(errorMessage))})},cancelSubmissionEnabled:function(enabled){return this.baseView.buttonEnabled(".action--submit-cancel-submission",enabled)},comment:function(text){var $submissionComments=$(".cancel_submission_comments",this.element);if(void 0===text)return $submissionComments.val();$submissionComments.val(text)},handleCommentChanged:function(){var isBlank=""!==$.trim(this.comment());this.cancelSubmissionEnabled(isBlank)},staffSubmitEnabled:function(scope,enabled){return this.baseView.buttonEnabled(".wrapper--staff-assessment .action--submit",enabled)},assessmentRubricChanges:function(key,changesExist){changesExist&&this.baseView.unsavedWarningEnabled(!0,key,gettext("If you leave this page without submitting your staff assessment, you will lose any work you have done."))},submitStaffOverride:function(submissionID,rubric,scope){var view=this,successCallback=function(){view.baseView.unsavedWarningEnabled(!1,view.OVERRIDE_UNSAVED_WARNING_KEY),view.loadStudentInfo("staff-info__student__grade")};this.callStaffAssess(submissionID,rubric,scope,successCallback,".staff-override-error","regrade")},submitStaffGrade:function(submissionID,rubric,scope,continueGrading){var view=this,successCallback=function(){view.baseView.unsavedWarningEnabled(!1,view.FULL_GRADE_UNSAVED_WARNING_KEY),view.staffGradeFormLoaded=!1,continueGrading?(view.loadStaffGradeForm(),view.baseView.scrollToTop(".openassessment__staff-area")):view.closeStaffGradeForm(!0)};this.callStaffAssess(submissionID,rubric,scope,successCallback,".staff-grade-error","full-grade")},callStaffAssess:function(submissionID,rubric,scope,successCallback,errorSelector,assessType){var view=this;view.staffSubmitEnabled(scope,!1),this.server.staffAssess(rubric.optionsSelected(),rubric.criterionFeedback(),rubric.overallFeedback(),submissionID,assessType).done(successCallback).fail(function(errorMessage){scope.find(errorSelector).html(_.escape(errorMessage)),view.staffSubmitEnabled(scope,!0)})}}}(OpenAssessment),OpenAssessment.StudentTrainingView=function(element,server,baseView){this.element=element,this.server=server,this.baseView=baseView,this.rubric=null,this.isRendering=!1,this.announceStatus=!1,this.dateFactory=new OpenAssessment.DateTimeFactory(this.element)},OpenAssessment.StudentTrainingView.prototype={load:function(usageID){var view=this,stepID=".step--student-training",focusID="[id='oa_training_"+usageID+"']";view.isRendering=!0,this.server.render("student_training").done(function(html){$(stepID,view.element).replaceWith(html),view.isRendering=!1,view.server.renderLatex($(stepID,view.element)),view.installHandlers(),view.baseView.announceStatusChangeToSRandFocus(stepID,usageID,!1,view,focusID),view.announceStatus=!1,view.dateFactory.apply()}).fail(function(){view.baseView.showLoadError("student-training")})},installHandlers:function(){var sel=$(".step--student-training",this.element),view=this;this.baseView.setUpCollapseExpand(sel);var rubricSelector=$(".student-training--001__assessment",this.element);if(rubricSelector.size()>0){var rubricElement=rubricSelector.get(0);this.rubric=new OpenAssessment.Rubric(rubricElement)}null!==this.rubric&&this.rubric.canSubmitCallback($.proxy(this.assessButtonEnabled,this)),sel.find(".student-training--001__assessment__submit").click(function(eventObject){eventObject.preventDefault(),view.assess(),view.announceStatus=!0})},assess:function(){this.assessButtonEnabled(!1);var options={};null!==this.rubric&&(options=this.rubric.optionsSelected());var view=this,baseView=this.baseView,usageID=baseView.getUsageID();this.server.trainingAssess(options).done(function(corrections){var incorrect=$(".openassessment__student-training--incorrect",view.element),instructions=$(".openassessment__student-training--instructions",view.element),$questionAnswers=$(".question__answers",view.rubric.element);view.rubric.showCorrections(corrections)?(instructions.addClass("is--hidden"),incorrect.removeClass("is--hidden"),$questionAnswers.each(function(index,answer){var $notification=$(".step__message.message",view.rubric.element).not(".is--hidden");$(answer).attr("aria-describedby",$($notification[index]).attr("id"))}),baseView.srReadTexts([gettext("Feedback available for selection.")])):(view.load(usageID),baseView.loadAssessmentModules(usageID),incorrect.addClass("is--hidden"),instructions.removeClass("is--hidden")),baseView.scrollToTop(".step--student-training")}).fail(function(errMsg){baseView.toggleActionError("student-training",errMsg),view.assessButtonEnabled(!0)})},assessButtonEnabled:function(isEnabled){return this.baseView.buttonEnabled(".student-training--001__assessment__submit",isEnabled)}};
